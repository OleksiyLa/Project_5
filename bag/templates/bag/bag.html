{% extends "base.html" %}
{% load static %}

{% block content %}
<main>
	<div class="container py-4">
		<div class="row">
			<div class="col">
				<h1 class="display-4 mb-4">Shopping Bag</h1>
				<hr class="mb-4">
			</div>
		</div>

		<div class="row">
			<div class="col">
				{% if bag_items %}
				<p class="h3 text-main-color">{{ bag_items|length }} item{{ bag_items|pluralize }} in your bag.</p>
					<div class="row">
						<div class="col">
							<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
								{% for item in bag_items %}
									<div class="col">
										<div class="card h-100 shadow">
											<div class="row g-0">
												<div class="col-md-4">
													<img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="img-fluid">
												</div>
												<div class="col-md-8">
													<div class="card-body d-flex flex-column justify-content-between h-100">
														<div>
															<h5 class="card-title">{{ item.product.name }} {{ item.size }}cm</h5>
															<p class="card-text">€{{ item.price }}</p>
														</div>
														<p>{{ item.toppings }}</p>
														<form class="form update-form mb-2" method="POST" action="{% url 'adjust_bag' item.item_id %}">
															{% csrf_token %}
															<input type="hidden" name="size" value="{{ item.size }}">
															<div class="input-group">
																<button class="btn btn-sm btn-custom rounded-0 decrement-qty change-qty" 
																		data-item-id="{{ item.item_id }}" data-item-size="{{ item.size }}" id="decrement-qty_{{ item.item_id }}_{{ item.size }}">
																	<i class="fas fa-minus"></i>
																</button>
																<input class="form-control form-control-sm qty_input text-center" type="number"
																		name="quantity" value="{{ item.quantity }}" min="1" max="99"
																		data-item-id="{{ item.item_id }}" data-item-size="{{ item.size }}"
																		id="id_qty_{{ item.item_id }}_{{ item.size }}" readonly>
																<button class="btn btn-sm btn-custom rounded-0 increment-qty change-qty"
																		data-item-id="{{ item.item_id }}" data-item-size="{{ item.size }}" id="increment-qty_{{ item.item_id }}_{{ item.size }}">
																	<i class="fas fa-plus"></i>
																</button>
															</div>
														</form>
														<a href="{% url 'remove_from_bag' item.item_id item.size %}" class="btn btn-sm btn-danger bg-red mt-2">
															<i class="fas fa-trash-alt"></i> Remove
														</a>
													</div>
												</div>
											</div>
										</div>
									</div>
								{% endfor %}
							</div>

							<div class="mt-4 d-flex justify-content-between">
								<p class="h3 text-main-color salsa">€{{ total }}</p>
								<button class="btn btn-custom">Checkout</button>
							</div>
						</div>
					</div>
				{% else %}
					<p class="lead mb-5 text-center">Your bag is empty.</p>
					<a href="{% url 'pizza_list' %}" class="btn btn-custom rounded-pill">
						<i class="fas fa-chevron-left mr-2"></i> Keep Shopping
					</a>
				{% endif %}
			</div>
		</div>
	</div>
</main>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
function handleEnableDisable(itemId, itemSize) {
	const inputElement = document.getElementById('id_qty_' + itemId + '_' + itemSize);
	if (inputElement) {
		const currentValue = parseInt(inputElement.value);
		const minusDisabled = currentValue < 2;
		const plusDisabled = currentValue > 98;
		const decrementButton = document.getElementById('decrement-qty_' + itemId + '_' + itemSize);
		const incrementButton = document.getElementById('increment-qty_' + itemId + '_' + itemSize);
		decrementButton.disabled = minusDisabled;
		incrementButton.disabled = plusDisabled;
	} 
}

function debounce(func, delay) {
  let timeoutId;
  return function () {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      func();
    }, delay);
  };
}

document.addEventListener('DOMContentLoaded', () => {
	document.querySelectorAll('.qty_input').forEach(input => {
		const itemId = input.dataset.itemId;
		const itemSize = input.dataset.itemSize;
		handleEnableDisable(itemId, itemSize);

		input.addEventListener('change', function() {
			const itemId = this.dataset.itemId;
			const itemSize = this.dataset.itemSize;
			handleEnableDisable(itemId, itemSize);
		});
	});

	document.querySelectorAll('.increment-qty').forEach(btn => {
		btn.addEventListener('click', function(e) {
			e.preventDefault();
			const itemId = this.dataset.itemId;
			const itemSize = this.dataset.itemSize;
			const closestInput = this.closest('.input-group').querySelector('.qty_input');
			const form = closestInput.parentNode.parentNode
			if (closestInput) {
				let currentValue = parseInt(closestInput.value);
				closestInput.value = currentValue + 1;
				handleEnableDisable(itemId, itemSize);
				debounce(() => {
					form.submit();
				}, 1000)();
			}
		});
	});

	document.querySelectorAll('.decrement-qty').forEach(btn => {
		btn.addEventListener('click', function(e) {
			e.preventDefault();
			const itemId = this.dataset.itemId;
			const itemSize = this.dataset.itemSize;
			const closestInput = this.closest('.input-group').querySelector('.qty_input');
			const form = closestInput.parentNode.parentNode
			if (closestInput) {
				let currentValue = parseInt(closestInput.value);
				closestInput.value = currentValue - 1;
				handleEnableDisable(itemId, itemSize);
				debounce(() => {
					form.submit();
				}, 1000)();
			}
		});
	});
});
</script>
{% endblock %}