{% extends "base.html" %}
{% load static %}

{% block title %}Pizza{% endblock title %}

{% block content %}

<main class="container mt-4">
	<div class="modal fade position-fixed" id="toppingLimitModal" tabindex="-1" aria-labelledby="toppingLimitModalLabel" aria-hidden="true">
		<div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="toppingLimitModalLabel">Topping Limit Exceeded</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          You can only select up to 7 additional toppings.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-custom" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
		</div>
	</div>
	<div class="row">
		<!-- Pizza details -->
		<div class="col-lg-10 offset-lg-1">
			<div class="pizza-detail">
				<div class="card shadow rounded">
					<div class="card-body text-center">
						<h2 class="card-title">{{ product.name }}</h2>
						<img src="{{ product.image.url }}" class="card-img-top pizza-image" alt="{{ product.name }}" style="max-width: 500px; height: auto;">
						<p class="card-text px-5">{{ product.description }}<span class="card-text-additional-toppings"></span></p>
						<div class="size-options my-4">
							<div class="btn-group" role="group" aria-label="Length options" id="pizza-size">
								<input type="radio" class="btn-check pizza-size-input" name="pizza-size" id="size-30" value="30" autocomplete="off" checked>
								<label class="btn btn-outline-primary" for="size-30">30cm</label>

								<input type="radio" class="btn-check pizza-size-input" name="pizza-size" id="size-35" value="35" autocomplete="off">
								<label class="btn btn-outline-primary" for="size-35">35cm</label>

								<input type="radio" class="btn-check pizza-size-input" name="pizza-size" id="size-40" value="40" autocomplete="off">
								<label class="btn btn-outline-primary" for="size-40">40cm</label>
							</div>
						</div>
						<p class="card-text text-red m-4"><strong class="price" data-base-price="{{ product.price }}">€{{ product.price }}</strong></p>
						<form class="add-to-cart-form mb-5" method="POST" action="{% url 'add_to_bag' product.id %}">
							{% csrf_token %}
							<input type="hidden" name="product_id" value="{{ product.id }}">
							<input type="hidden" name="selected_size" class="selected-size" value="30">
							<input type="hidden" name="additional_toppings" class="selected-toppings" value="">
							<input type="hidden" name="redirect_url" value="{{ full_path }}">
							<button type="submit" class="btn btn-primary btn-custom rounded-2 p-2">Add to Cart</button>
						</form>
					</div>
				</div>
			</div>
		</div>
		<!-- Toppings -->
		<div class="mt-4">
			<h2 class="mb-2 text-center text-main-color salsa">Additional Toppings</h2>
			<div class="row d-flex justify-content-around">
				{% for topping in toppings %}
					<div class="card topping-card position-relative my-4 rounded-3">
						<div class="row g-0 text-center">
							<div class="card-body">
								<img src="{{ topping.image.url }}" class="img-fluid topping-image" alt="Topping">
								<h5 class="card-title my-3">{{ topping.name }}</h5>
								<p class="card-text topping-price" data-base-price="{{ topping.price }}">€{{ topping.price }}</p>
								<i class="fa fa-plus add-icon" data-topping-id="{{ topping.id }}" aria-label="select topping"></i>
							</div>
						</div>
					</div>
				{% endfor %}
			</div>
		</div>
	</div>
</main>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
	const updateTotalPrice = () => {
    const basePrice = parseFloat(document.querySelector('.price').getAttribute('data-base-price'));
    let totalPrice = basePrice;
    const selectedSize = document.querySelector('.selected-size').value;
    let multiplier = 1;
    if (selectedSize === '35') {
      multiplier = 1.1;
    } else if (selectedSize === '40') {
      multiplier = 1.3;
    }
    totalPrice *= multiplier;
    const selectedToppingsInput = document.querySelector('.selected-toppings');
    if (selectedToppingsInput.value === '') {
      document.querySelector('.price').textContent = `€${totalPrice.toFixed(2)}`;
      return;
    }
    const selectedToppings = selectedToppingsInput.value.split(',');
    const toppingCards = document.querySelectorAll('.topping-card');
    selectedToppings.forEach(toppingId => {
      toppingCards.forEach(toppingCard => {
        const toppingPriceElement = toppingCard.querySelector('.topping-price');
        const toppingIdValue = toppingCard.querySelector('.add-icon').getAttribute('data-topping-id');
        const toppingPrice = parseFloat(toppingPriceElement.getAttribute('data-base-price'));

        if (toppingId === toppingIdValue) {
          const newToppingPrice = toppingPrice * multiplier;
          totalPrice += newToppingPrice;
        }
      });
    });
    document.querySelector('.price').textContent = `€${totalPrice.toFixed(2)}`;
  };

  const additionalToppingsText = document.querySelector('.card-text-additional-toppings');
	const toppingIcons = document.querySelectorAll('.add-icon');
	const selectedToppingsInput = document.querySelector('.selected-toppings');

	toppingIcons.forEach(icon => {
		icon.addEventListener('click', function() {
			const toppingId = this.getAttribute('data-topping-id');
			const card = this.closest('.topping-card');
			if (selectedToppingsInput.value === '') {
				selectedToppingsInput.value = toppingId;
				this.classList.add('selected');
				this.classList.remove('fa-plus');
				this.classList.add('fa-minus');
				card.classList.add('selected');
				additionalToppingsText.textContent += (', ' + card.querySelector('.card-title').textContent);
			} else {
				let selectedToppings = selectedToppingsInput.value.split(',');
				const index = selectedToppings.indexOf(toppingId);
				if (index !== -1) {
					selectedToppings.splice(index, 1);
					this.classList.remove('selected');
					this.classList.add('fa-plus');
					this.classList.remove('fa-minus');
					card.classList.remove('selected');
					additionalToppingsText.textContent = additionalToppingsText.textContent.split(', ').filter(topping => {
						if (!(topping === card.querySelector('.card-title').textContent)) {
						return true;
						}
					}).join(', ');
				} else {
					if (selectedToppings.length === 7) {
						const toppingLimitModal = new bootstrap.Modal(document.getElementById('toppingLimitModal'));
						toppingLimitModal.show();
						return;
				}
					selectedToppings.push(toppingId);
					this.classList.add('selected');
					this.classList.remove('fa-plus');
					this.classList.add('fa-minus');
					card.classList.add('selected');
					additionalToppingsText.textContent += (', ' + card.querySelector('.card-title').textContent);
							}
							selectedToppingsInput.value = selectedToppings.join(',');
						}
						updateTotalPrice();
					});
	});

	let multiplier = 1;
	const toppingCards = document.querySelectorAll('.topping-card');
	const sizeInputs = document.querySelectorAll('.pizza-size-input');
	sizeInputs.forEach(input => {
		input.addEventListener('change', function() {
			const selectedSize = this.value;
			const card = this.closest('.card');
			const basePrice = parseFloat(card.querySelector('.price').getAttribute('data-base-price'));
			let adjustedPrice = basePrice;

			multiplier = 1;
			if (selectedSize === '35') {
				multiplier = 1.1;
			} else if (selectedSize === '40') {
				multiplier = 1.3;
			}
			card.querySelector('.selected-size').value = selectedSize;
			const image = card.querySelector('.card-img-top');
			if (selectedSize === '35') {
				image.style.transform = 'scale(1)';
			} else if (selectedSize === '40') {
				image.style.transform = 'scale(1.02)';
			} else {
				image.style.transform = 'scale(0.98)';
			}

			toppingCards.forEach(toppingCard => {
				const toppingPriceElement = toppingCard.querySelector('.topping-price');
				const toppingPrice = parseFloat(toppingPriceElement.getAttribute('data-base-price'));
				const newToppingPrice = toppingPrice * multiplier;
				toppingPriceElement.textContent = `€${newToppingPrice.toFixed(2)}`;
			});
			updateTotalPrice();
		});
	});
});
</script>
{% endblock %}